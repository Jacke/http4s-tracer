<html><head><title>Http4s Tracer: Guide</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="ProfunKtor" /><meta name="description" content="End-to-end tracing system for Http4s" /><meta name="og:image" content="/img/poster.png" /><meta name="og:title" content="Http4s Tracer: Guide" /><meta name="og:site_name" content="Http4s Tracer" /><meta name="og:url" content="https://http4s-tracer.profunktor.dev/" /><meta name="og:type" content="website" /><meta name="og:description" content="End-to-end tracing system for Http4s" /><link rel="icon" type="image/png" href="/img/favicon.png" /><meta name="twitter:title" content="Http4s Tracer: Guide" /><meta name="twitter:image" content="https://http4s-tracer.profunktor.dev/img/poster.png" /><meta name="twitter:description" content="End-to-end tracing system for Http4s" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/img/favicon310x150.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/highlight/styles/default.css" /><link rel="stylesheet" href="/css/style.css" /><link rel="stylesheet" href="/css/palette.css" /><link rel="stylesheet" href="/css/codemirror.css" /><link rel="stylesheet" href="/css/toc.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/" class="brand"><div class="brand-wrapper"><span>Http4s Tracer</span></div></a></li> <li><a href="/overview.html" class="">Overview</a></li> <li><a href="/motivations.html" class="">Motivations</a></li> <li><a href="/guide.html" class=" active ">Guide</a></li></ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/profunktor/http4s-tracer"><i class="fa fa-eye"></i><span>WATCH<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/profunktor/http4s-tracer"><i class="fa fa-star-o"></i><span>STARS<span id="stars" class="label label-default">--</span></span></a></li><li><a href="#" onclick="shareSiteTwitter('Http4s Tracer End-to-end tracing system for Http4s');"><i class="fa fa-twitter"></i></a></li><li><a href="#" onclick="shareSiteFacebook('Http4s Tracer End-to-end tracing system for Http4s');"><i class="fa fa-facebook"></i></a></li><li><a href="#" onclick="shareSiteGoogle();"><i class="fa fa-google-plus"></i></a></li></ul></div></div></div></div><div id="content" data-github-owner="profunktor" data-github-repo="http4s-tracer"><div class="content-wrapper"><section><h1 id="a-guide-to-a-complete-application-using-http4s-tracer">A guide to a complete application using Http4s Tracer</h1>

<p>The following example will follow a (recommended) <a href="http://okmij.org/ftp/tagless-final/index.html">tagless final</a> encoding:</p>

<nav role="navigation" id="toc"></nav>

<h3 id="tagless-final-application">Tagless final application</h3>

<h4 id="domain-model--errors">Domain model &amp; Errors</h4>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">Username</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">AnyVal</span>
<span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">User</span><span class="o">(</span><span class="n">username</span><span class="k">:</span> <span class="kt">Username</span><span class="o">)</span>

<span class="k">sealed</span> <span class="k">trait</span> <span class="nc">UserError</span> <span class="k">extends</span> <span class="nc">Exception</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">UserAlreadyExists</span><span class="o">(</span><span class="n">username</span><span class="k">:</span> <span class="kt">Username</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">UserError</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">UserNotFound</span><span class="o">(</span><span class="n">username</span><span class="k">:</span> <span class="kt">Username</span><span class="o">)</span>      <span class="k">extends</span> <span class="nc">UserError</span>
</code></pre></div></div>

<h4 id="algebras">Algebras</h4>

<p>Also known as interfaces, they define the functionality we want to expose and we will only operate in terms of these definitions:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">trait</span> <span class="nc">UserAlgebra</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">find</span><span class="o">(</span><span class="n">username</span><span class="k">:</span> <span class="kt">Username</span><span class="o">)</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">User</span><span class="o">]</span>
  <span class="k">def</span> <span class="n">persist</span><span class="o">(</span><span class="n">user</span><span class="k">:</span> <span class="kt">User</span><span class="o">)</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span>
<span class="o">}</span>

<span class="k">trait</span> <span class="nc">UserRepository</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">find</span><span class="o">(</span><span class="n">username</span><span class="k">:</span> <span class="kt">Username</span><span class="o">)</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">Option</span><span class="o">[</span><span class="kt">User</span><span class="o">]]</span>
  <span class="k">def</span> <span class="n">persist</span><span class="o">(</span><span class="n">user</span><span class="k">:</span> <span class="kt">User</span><span class="o">)</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span>
<span class="o">}</span>

<span class="k">trait</span> <span class="nc">UserRegistry</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">register</span><span class="o">(</span><span class="n">user</span><span class="k">:</span> <span class="kt">User</span><span class="o">)</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="programs">Programs</h4>

<p>Contains pure logic. It can possiby combine multiple algebras as well as other programs but without commiting to a specific implementation:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.MonadError</span>
<span class="k">import</span> <span class="nn">cats.implicits._</span>
<span class="k">import</span> <span class="nn">cats.temp.par._</span>

<span class="k">class</span> <span class="nc">UserProgram</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Par</span><span class="o">](</span><span class="n">repo</span><span class="k">:</span> <span class="kt">UserRepository</span><span class="o">[</span><span class="kt">F</span><span class="o">],</span> <span class="n">registry</span><span class="k">:</span> <span class="kt">UserRegistry</span><span class="o">[</span><span class="kt">F</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">F</span><span class="k">:</span> <span class="kt">MonadError</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Throwable</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">UserAlgebra</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">find</span><span class="o">(</span><span class="n">username</span><span class="k">:</span> <span class="kt">Username</span><span class="o">)</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">User</span><span class="o">]</span> <span class="k">=</span>
    <span class="n">repo</span><span class="o">.</span><span class="n">find</span><span class="o">(</span><span class="n">username</span><span class="o">).</span><span class="n">flatMap</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">u</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">F</span><span class="o">.</span><span class="n">pure</span><span class="o">(</span><span class="n">u</span><span class="o">)</span>
      <span class="k">case</span> <span class="nc">None</span>    <span class="k">=&gt;</span> <span class="n">F</span><span class="o">.</span><span class="n">raiseError</span><span class="o">(</span><span class="nc">UserNotFound</span><span class="o">(</span><span class="n">username</span><span class="o">))</span>
    <span class="o">}</span>

  <span class="k">def</span> <span class="n">persist</span><span class="o">(</span><span class="n">user</span><span class="k">:</span> <span class="kt">User</span><span class="o">)</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
    <span class="n">repo</span><span class="o">.</span><span class="n">find</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="o">).</span><span class="n">flatMap</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">F</span><span class="o">.</span><span class="n">raiseError</span><span class="o">(</span><span class="nc">UserAlreadyExists</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="o">))</span>
      <span class="k">case</span> <span class="nc">None</span>    <span class="k">=&gt;</span> <span class="o">(</span><span class="n">registry</span><span class="o">.</span><span class="n">register</span><span class="o">(</span><span class="n">user</span><span class="o">),</span> <span class="n">repo</span><span class="o">.</span><span class="n">persist</span><span class="o">(</span><span class="n">user</span><span class="o">)).</span><span class="n">parTupled</span><span class="o">.</span><span class="n">void</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<h4 id="interpreters">Interpreters</h4>

<p>In this case we will only have a single interpreter for our <code class="highlighter-rouge">Repository</code>: an in-memory implementation based on <code class="highlighter-rouge">Ref</code>.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.effect._</span>
<span class="k">import</span> <span class="nn">cats.effect.concurrent.Ref</span>

<span class="k">class</span> <span class="nc">MemUserRepository</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Sync</span><span class="o">]</span> <span class="o">(</span>
    <span class="n">state</span><span class="k">:</span> <span class="kt">Ref</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Map</span><span class="o">[</span><span class="kt">Username</span>, <span class="kt">User</span><span class="o">]]</span>
<span class="o">)</span> <span class="k">extends</span> <span class="nc">UserRepository</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span> <span class="o">{</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">find</span><span class="o">(</span><span class="n">username</span><span class="k">:</span> <span class="kt">Username</span><span class="o">)</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">Option</span><span class="o">[</span><span class="kt">User</span><span class="o">]]</span> <span class="k">=</span>
    <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">username</span><span class="o">))</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">persist</span><span class="o">(</span><span class="n">user</span><span class="k">:</span> <span class="kt">User</span><span class="o">)</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
    <span class="n">state</span><span class="o">.</span><span class="n">update</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">updated</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="o">,</span> <span class="n">user</span><span class="o">))</span>

<span class="o">}</span>

<span class="k">object</span> <span class="nc">MemUserRepository</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">create</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Sync</span><span class="o">]</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">UserRepository</span><span class="o">[</span><span class="kt">F</span><span class="o">]]</span> <span class="k">=</span>
    <span class="nc">Ref</span><span class="o">.</span><span class="n">of</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Map</span><span class="o">[</span><span class="kt">Username</span>, <span class="kt">User</span><span class="o">]](</span><span class="nc">Map</span><span class="o">.</span><span class="n">empty</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="k">new</span> <span class="nc">MemUserRepository</span><span class="o">[</span><span class="kt">F</span><span class="o">](</span><span class="k">_</span><span class="o">))</span>
<span class="o">}</span>
</code></pre></div></div>

<p>And an interpreter for our <code class="highlighter-rouge">UserRegistry</code> which calls an external http service. But first we need to define some Json codecs that will also be used by all our <code class="highlighter-rouge">HttpRoutes</code>:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">io.circe.</span><span class="o">{</span><span class="nc">Decoder</span><span class="o">,</span> <span class="nc">Encoder</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">io.circe.generic.extras.decoding.UnwrappedDecoder</span>
<span class="k">import</span> <span class="nn">io.circe.generic.extras.encoding.UnwrappedEncoder</span>
<span class="k">import</span> <span class="nn">org.http4s._</span>
<span class="k">import</span> <span class="nn">org.http4s.circe._</span>

<span class="k">implicit</span> <span class="k">def</span> <span class="n">valueClassEncoder</span><span class="o">[</span><span class="kt">A:</span> <span class="kt">UnwrappedEncoder</span><span class="o">]</span><span class="k">:</span> <span class="kt">Encoder</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="n">implicitly</span>
<span class="k">implicit</span> <span class="k">def</span> <span class="n">valueClassDecoder</span><span class="o">[</span><span class="kt">A:</span> <span class="kt">UnwrappedDecoder</span><span class="o">]</span><span class="k">:</span> <span class="kt">Decoder</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="n">implicitly</span>

<span class="k">implicit</span> <span class="k">def</span> <span class="n">jsonDecoder</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Sync</span>, <span class="kt">A</span> <span class="k">&lt;:</span> <span class="kt">Product:</span> <span class="kt">Decoder</span><span class="o">]</span><span class="k">:</span> <span class="kt">EntityDecoder</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="n">jsonOf</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">A</span><span class="o">]</span>
<span class="k">implicit</span> <span class="k">def</span> <span class="n">jsonEncoder</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Sync</span>, <span class="kt">A</span> <span class="k">&lt;:</span> <span class="kt">Product:</span> <span class="kt">Encoder</span><span class="o">]</span><span class="k">:</span> <span class="kt">EntityEncoder</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="n">jsonEncoderOf</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">A</span><span class="o">]</span>
</code></pre></div></div>

<p>Here’s our interpreter for <code class="highlighter-rouge">UserRegistry</code>:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">io.circe.syntax._</span>
<span class="k">import</span> <span class="nn">org.http4s.Method._</span>
<span class="k">import</span> <span class="nn">org.http4s.client.Client</span>
<span class="k">import</span> <span class="nn">org.http4s.client.dsl.Http4sClientDsl</span>

<span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">LiveUserRegistry</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Sync</span><span class="o">](</span><span class="n">client</span><span class="k">:</span> <span class="kt">Client</span><span class="o">[</span><span class="kt">F</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">UserRegistry</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span>  <span class="k">with</span> <span class="nc">Http4sClientDsl</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span> <span class="o">{</span>

  <span class="k">private</span> <span class="k">val</span> <span class="n">uri</span> <span class="k">=</span> <span class="nc">Uri</span><span class="o">.</span><span class="n">uri</span><span class="o">(</span><span class="s">"https://jsonplaceholder.typicode.com/posts"</span><span class="o">)</span>

  <span class="k">def</span> <span class="n">register</span><span class="o">(</span><span class="n">user</span><span class="k">:</span> <span class="kt">User</span><span class="o">)</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
    <span class="n">client</span><span class="o">.</span><span class="n">successful</span><span class="o">(</span><span class="nc">POST</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="n">asJson</span><span class="o">,</span> <span class="n">uri</span><span class="o">)).</span><span class="n">void</span>
<span class="o">}</span>

</code></pre></div></div>

<h3 id="distributed-tracing">Distributed Tracing</h3>

<p>Note that until here we have only defined <code class="highlighter-rouge">algebras</code>, <code class="highlighter-rouge">programs</code> and <code class="highlighter-rouge">interpreters</code> that can easily be tested in isolation. Neither tracing nor logging concepts so far. And as mentioned in the overview section, the <code class="highlighter-rouge">HttpRoutes</code> should only be aware of it but we’ll also need some tracer interpreters and we will soon see what this means.</p>

<h4 id="http-routes">Http Routes</h4>

<p>Use <code class="highlighter-rouge">Http4sTracerDsl[F]</code> and <code class="highlighter-rouge">TracedHttpRoute</code> instead of <code class="highlighter-rouge">Http4sDsl[F]</code> and <code class="highlighter-rouge">HttpRoutes.of[F]</code> respectively.</p>

<p><em>For authenticated routes use <code class="highlighter-rouge">Http4sAuthTracerDsl[F]</code> and <code class="highlighter-rouge">AuthTracedHttpRoute[T, F]</code> instead.</em></p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">dev.profunktor.tracer.Trace._</span>
<span class="k">import</span> <span class="nn">dev.profunktor.tracer.</span><span class="o">{</span><span class="nc">Http4sTracerDsl</span><span class="o">,</span> <span class="nc">TracedHttpRoute</span><span class="o">,</span> <span class="nc">Tracer</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">io.circe.generic.auto._</span>
<span class="k">import</span> <span class="nn">org.http4s.server.Router</span>

<span class="k">class</span> <span class="nc">UserRoutes</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Sync:</span> <span class="kt">Tracer</span><span class="o">](</span><span class="n">users</span><span class="k">:</span> <span class="kt">UserAlgebra</span><span class="o">[</span><span class="kt">Trace</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">?</span><span class="o">]])</span> <span class="k">extends</span> <span class="nc">Http4sTracerDsl</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span> <span class="o">{</span>

  <span class="k">private</span> <span class="k">val</span> <span class="nc">PathPrefix</span> <span class="k">=</span> <span class="s">"/users"</span>

  <span class="k">private</span> <span class="k">val</span> <span class="n">httpRoutes</span><span class="k">:</span> <span class="kt">HttpRoutes</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span> <span class="k">=</span> <span class="nc">TracedHttpRoute</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">GET</span> <span class="o">-&gt;</span> <span class="nc">Root</span> <span class="o">/</span> <span class="n">username</span> <span class="n">using</span> <span class="n">traceId</span> <span class="k">=&gt;</span>
      <span class="n">users</span>
        <span class="o">.</span><span class="n">find</span><span class="o">(</span><span class="nc">Username</span><span class="o">(</span><span class="n">username</span><span class="o">))</span>
        <span class="o">.</span><span class="n">run</span><span class="o">(</span><span class="n">traceId</span><span class="o">)</span>
        <span class="o">.</span><span class="n">flatMap</span><span class="o">(</span><span class="n">user</span> <span class="k">=&gt;</span> <span class="nc">Ok</span><span class="o">(</span><span class="n">user</span><span class="o">))</span>
        <span class="o">.</span><span class="n">handleErrorWith</span> <span class="o">{</span>
          <span class="k">case</span> <span class="nc">UserNotFound</span><span class="o">(</span><span class="n">u</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">NotFound</span><span class="o">(</span><span class="n">u</span><span class="o">.</span><span class="n">value</span><span class="o">)</span>
        <span class="o">}</span>

    <span class="k">case</span> <span class="n">tr</span> <span class="k">@</span> <span class="nc">POST</span> <span class="o">-&gt;</span> <span class="nc">Root</span> <span class="n">using</span> <span class="n">traceId</span> <span class="k">=&gt;</span>
      <span class="n">tr</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">decode</span><span class="o">[</span><span class="kt">User</span><span class="o">]</span> <span class="o">{</span> <span class="n">user</span> <span class="k">=&gt;</span>
        <span class="n">users</span>
          <span class="o">.</span><span class="n">persist</span><span class="o">(</span><span class="n">user</span><span class="o">)</span>
          <span class="o">.</span><span class="n">run</span><span class="o">(</span><span class="n">traceId</span><span class="o">)</span>
          <span class="o">.</span><span class="n">flatMap</span><span class="o">(</span><span class="k">_</span> <span class="k">=&gt;</span> <span class="nc">Created</span><span class="o">())</span>
          <span class="o">.</span><span class="n">handleErrorWith</span> <span class="o">{</span>
             <span class="k">case</span> <span class="nc">UserAlreadyExists</span><span class="o">(</span><span class="n">u</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Conflict</span><span class="o">(</span><span class="n">u</span><span class="o">.</span><span class="n">value</span><span class="o">)</span>
          <span class="o">}</span>
      <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">val</span> <span class="n">routes</span><span class="k">:</span> <span class="kt">HttpRoutes</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Router</span><span class="o">(</span>
    <span class="nc">PathPrefix</span> <span class="o">-&gt;</span> <span class="n">httpRoutes</span>
  <span class="o">)</span>

<span class="o">}</span>
</code></pre></div></div>

<p>There are a couple of things going on here:</p>

<ul>
  <li>We require an <code class="highlighter-rouge">UserAlgebra[Trace[F, ?]]</code> instead of a plain <code class="highlighter-rouge">UserAlgebra[F]</code>.</li>
  <li>We need an instance of <code class="highlighter-rouge">Tracer[F]</code> in scope to make sure we are getting the right header.</li>
</ul>

<p>This is necessary to pass the “Trace-Id” along and we’ll soon see how to do it.</p>

<h3 id="modules">Modules</h3>

<p>The recommended way to structure tagless final applications is to group things in different modules. For this simple application we will define four modules: <code class="highlighter-rouge">HttpApi</code>, <code class="highlighter-rouge">HttpClients</code>, <code class="highlighter-rouge">Programs</code> and <code class="highlighter-rouge">Repositories</code>. In a larger application we might have more modules but the idea remains the same.</p>

<h4 id="repositories-module">Repositories module</h4>

<p>This is the “master algebra of repositories”. And in addition, we provide a way of creating the in-memory interpreter since its creation is effectful.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">trait</span> <span class="nc">Repositories</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">users</span><span class="k">:</span> <span class="kt">UserRepository</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span>
<span class="o">}</span>

<span class="k">final</span> <span class="k">class</span> <span class="nc">LiveRepositories</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]](</span><span class="n">usersRepo</span><span class="k">:</span> <span class="kt">UserRepository</span><span class="o">[</span><span class="kt">F</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">Repositories</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">users</span><span class="k">:</span> <span class="kt">UserRepository</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span> <span class="k">=</span> <span class="n">usersRepo</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">LiveRepositories</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">apply</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Sync</span><span class="o">]</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">Repositories</span><span class="o">[</span><span class="kt">F</span><span class="o">]]</span> <span class="k">=</span>
    <span class="nc">MemUserRepository</span><span class="o">.</span><span class="n">create</span><span class="o">[</span><span class="kt">F</span><span class="o">].</span><span class="n">map</span><span class="o">(</span><span class="k">new</span> <span class="nc">LiveRepositories</span><span class="o">[</span><span class="kt">F</span><span class="o">](</span><span class="k">_</span><span class="o">))</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="http-clients-module">Http Clients module</h4>

<p>The master algebra of the http clients.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">trait</span> <span class="nc">HttpClients</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">userRegistry</span><span class="k">:</span> <span class="kt">UserRegistry</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span>
<span class="o">}</span>

<span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">LiveHttpClients</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Sync</span><span class="o">](</span><span class="n">client</span><span class="k">:</span> <span class="kt">Client</span><span class="o">[</span><span class="kt">F</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">HttpClients</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">userRegistry</span><span class="k">:</span> <span class="kt">UserRegistry</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span> <span class="k">=</span> <span class="nc">LiveUserRegistry</span><span class="o">[</span><span class="kt">F</span><span class="o">](</span><span class="n">client</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="programs-module">Programs module</h4>

<p>This module is going to be the “master algebra” that groups all the single algebras.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">trait</span> <span class="nc">Programs</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">users</span><span class="k">:</span> <span class="kt">UserAlgebra</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span>
<span class="o">}</span>

<span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">LivePrograms</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Par:</span> <span class="kt">Sync</span><span class="o">](</span><span class="n">repos</span><span class="k">:</span> <span class="kt">Repositories</span><span class="o">[</span><span class="kt">F</span><span class="o">],</span> <span class="n">clients</span><span class="k">:</span> <span class="kt">HttpClients</span><span class="o">[</span><span class="kt">F</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">Programs</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">users</span><span class="k">:</span> <span class="kt">UserAlgebra</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">UserProgram</span><span class="o">[</span><span class="kt">F</span><span class="o">](</span><span class="n">repos</span><span class="o">.</span><span class="n">users</span><span class="o">,</span> <span class="n">clients</span><span class="o">.</span><span class="n">userRegistry</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="httpapi-module">HttpApi module</h4>

<p>Before we look into the <code class="highlighter-rouge">HttpApi</code> module let’s look into the <code class="highlighter-rouge">middleware</code> signature:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="n">middleware</span><span class="o">(</span>
  <span class="n">http</span><span class="k">:</span> <span class="kt">HttpApp</span><span class="o">[</span><span class="kt">F</span><span class="o">],</span>
  <span class="n">logRequest</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="kc">false</span><span class="o">,</span>
  <span class="n">logResponse</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="kc">false</span>
<span class="o">)(</span><span class="k">implicit</span> <span class="n">F</span><span class="k">:</span> <span class="kt">Sync</span><span class="o">[</span><span class="kt">F</span><span class="o">],</span> <span class="n">L</span><span class="k">:</span> <span class="kt">TracerLog</span><span class="o">[</span><span class="kt">Trace</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">?</span><span class="o">]])</span><span class="k">:</span> <span class="kt">HttpApp</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
</code></pre></div></div>

<p>You can change the default values of the boolean flags if you want to have the request and/or response logged. If you want both activated there’s a another constructor provided by the library:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="n">loggingMiddleware</span><span class="o">(</span>
    <span class="n">http</span><span class="k">:</span> <span class="kt">HttpApp</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span>
<span class="o">)(</span><span class="k">implicit</span> <span class="n">F</span><span class="k">:</span> <span class="kt">Sync</span><span class="o">[</span><span class="kt">F</span><span class="o">],</span> <span class="n">L</span><span class="k">:</span> <span class="kt">TracerLog</span><span class="o">[</span><span class="kt">Trace</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">?</span><span class="o">]])</span><span class="k">:</span> <span class="kt">HttpApp</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span> <span class="k">=</span>
  <span class="n">middleware</span><span class="o">(</span><span class="n">http</span><span class="o">,</span> <span class="n">logRequest</span> <span class="k">=</span> <span class="kc">true</span><span class="o">,</span> <span class="n">logResponse</span> <span class="k">=</span> <span class="kc">true</span><span class="o">)</span>
</code></pre></div></div>

<p>Finally, here we define our <code class="highlighter-rouge">HttpRoutes</code> and tracing middleware.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">dev.profunktor.tracer.Trace.Trace</span>
<span class="k">import</span> <span class="nn">dev.profunktor.tracer.</span><span class="o">{</span><span class="nc">Tracer</span><span class="o">,</span> <span class="nc">TracerLog</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">org.http4s.implicits._</span>
<span class="k">import</span> <span class="nn">org.http4s.</span><span class="o">{</span><span class="nc">HttpApp</span><span class="o">,</span> <span class="nc">HttpRoutes</span><span class="o">}</span>

<span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">HttpApi</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Sync:</span> <span class="kt">Tracer</span><span class="o">](</span><span class="n">programs</span><span class="k">:</span> <span class="kt">Programs</span><span class="o">[</span><span class="kt">Trace</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">?</span><span class="o">]])(</span><span class="k">implicit</span> <span class="n">L</span><span class="k">:</span> <span class="kt">TracerLog</span><span class="o">[</span><span class="kt">Trace</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">?</span><span class="o">]])</span> <span class="o">{</span>

  <span class="k">private</span> <span class="k">val</span> <span class="n">httpRoutes</span><span class="k">:</span> <span class="kt">HttpRoutes</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span> <span class="k">=</span>
    <span class="k">new</span> <span class="nc">UserRoutes</span><span class="o">[</span><span class="kt">F</span><span class="o">](</span><span class="n">programs</span><span class="o">.</span><span class="n">users</span><span class="o">).</span><span class="n">routes</span>

  <span class="k">val</span> <span class="n">httpApp</span><span class="k">:</span> <span class="kt">HttpApp</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">Tracer</span><span class="o">[</span><span class="kt">F</span><span class="o">].</span><span class="n">middleware</span><span class="o">(</span><span class="n">httpRoutes</span><span class="o">.</span><span class="n">orNotFound</span><span class="o">)</span>

<span class="o">}</span>
</code></pre></div></div>

<p>Note that we again require a <code class="highlighter-rouge">Programs[Trace[F, ?]]</code> instead of just <code class="highlighter-rouge">Programs[F]</code> and also an instance of <code class="highlighter-rouge">TracerLog[Trace[F, ?]]</code> required by <code class="highlighter-rouge">Tracer[F].middleware</code>.</p>

<h3 id="tracers">Tracers</h3>

<p>Now that we have defined our program, http routes and modules it’s time to introduce the “tracers”. These are just interpreters with tracing and logging capabilities written on top of our “group modules”. Let’s see the code.</p>

<h4 id="traced-repositories">Traced Repositories</h4>

<p>We extend <code class="highlighter-rouge">Repositories[Trace[F, ?]]</code> (notice the change in the effect type), receive <code class="highlighter-rouge">Repositories[F]</code> as a parameter and provide the necessary tracing interpreters.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.FlatMap</span>
<span class="k">import</span> <span class="nn">dev.profunktor.tracer.Trace</span>
<span class="k">import</span> <span class="nn">dev.profunktor.tracer.Trace.Trace</span>
<span class="k">import</span> <span class="nn">dev.profunktor.tracer.TracerLog</span>

<span class="k">final</span> <span class="k">class</span> <span class="nc">UserTracerRepository</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">FlatMap</span><span class="o">](</span><span class="n">repo</span><span class="k">:</span> <span class="kt">UserRepository</span><span class="o">[</span><span class="kt">F</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">L</span><span class="k">:</span> <span class="kt">TracerLog</span><span class="o">[</span><span class="kt">Trace</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">?</span><span class="o">]])</span> <span class="k">extends</span> <span class="nc">UserRepository</span><span class="o">[</span><span class="kt">Trace</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">?</span><span class="o">]]</span> <span class="o">{</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">find</span><span class="o">(</span><span class="n">username</span><span class="k">:</span> <span class="kt">Username</span><span class="o">)</span><span class="k">:</span> <span class="kt">Trace</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Option</span><span class="o">[</span><span class="kt">User</span><span class="o">]]</span> <span class="k">=</span>
    <span class="n">L</span><span class="o">.</span><span class="n">info</span><span class="o">[</span><span class="kt">UserRepository</span><span class="o">[</span><span class="kt">F</span><span class="o">]](</span><span class="n">s</span><span class="s">"Find user by username: ${username.value}"</span><span class="o">)</span> <span class="o">*&gt;</span>
      <span class="nc">Trace</span><span class="o">(</span><span class="k">_</span> <span class="k">=&gt;</span> <span class="n">repo</span><span class="o">.</span><span class="n">find</span><span class="o">(</span><span class="n">username</span><span class="o">))</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">persist</span><span class="o">(</span><span class="n">user</span><span class="k">:</span> <span class="kt">User</span><span class="o">)</span><span class="k">:</span> <span class="kt">Trace</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
    <span class="n">L</span><span class="o">.</span><span class="n">info</span><span class="o">[</span><span class="kt">UserRepository</span><span class="o">[</span><span class="kt">F</span><span class="o">]](</span><span class="n">s</span><span class="s">"Persisting user: ${user.username.value}"</span><span class="o">)</span> <span class="o">*&gt;</span>
      <span class="nc">Trace</span><span class="o">(</span><span class="k">_</span> <span class="k">=&gt;</span> <span class="n">repo</span><span class="o">.</span><span class="n">persist</span><span class="o">(</span><span class="n">user</span><span class="o">))</span>

<span class="o">}</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">TracedRepositories</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">FlatMap</span><span class="o">](</span><span class="n">repos</span><span class="k">:</span> <span class="kt">Repositories</span><span class="o">[</span><span class="kt">F</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">L</span><span class="k">:</span> <span class="kt">TracerLog</span><span class="o">[</span><span class="kt">Trace</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">?</span><span class="o">]])</span> <span class="k">extends</span> <span class="nc">Repositories</span><span class="o">[</span><span class="kt">Trace</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">?</span><span class="o">]]</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">users</span><span class="k">:</span> <span class="kt">UserRepository</span><span class="o">[</span><span class="kt">Trace</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">?</span><span class="o">]]</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">UserTracerRepository</span><span class="o">[</span><span class="kt">F</span><span class="o">](</span><span class="n">repos</span><span class="o">.</span><span class="n">users</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="traced-http-clients">Traced Http Clients</h4>

<p>Again we extend <code class="highlighter-rouge">HttpClients[Trace[F, ?]]</code> and receive <code class="highlighter-rouge">Client[F]</code> as a parameter:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">final</span> <span class="k">class</span> <span class="nc">TracedUserRegistry</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Sync</span><span class="o">](</span><span class="n">registry</span><span class="k">:</span> <span class="kt">UserRegistry</span><span class="o">[</span><span class="kt">F</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">L</span><span class="k">:</span> <span class="kt">TracerLog</span><span class="o">[</span><span class="kt">Trace</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">?</span><span class="o">]])</span> <span class="k">extends</span> <span class="nc">UserRegistry</span><span class="o">[</span><span class="kt">Trace</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">?</span><span class="o">]]</span> <span class="o">{</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">register</span><span class="o">(</span><span class="n">user</span><span class="k">:</span> <span class="kt">User</span><span class="o">)</span><span class="k">:</span> <span class="kt">Trace</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
    <span class="n">L</span><span class="o">.</span><span class="n">info</span><span class="o">[</span><span class="kt">UserRegistry</span><span class="o">[</span><span class="kt">F</span><span class="o">]](</span><span class="n">s</span><span class="s">"Registering user: ${user.username.value}"</span><span class="o">)</span> <span class="o">*&gt;</span>
      <span class="nc">Trace</span><span class="o">(</span><span class="k">_</span> <span class="k">=&gt;</span> <span class="n">registry</span><span class="o">.</span><span class="n">register</span><span class="o">(</span><span class="n">user</span><span class="o">))</span>

<span class="o">}</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">TracedHttpClients</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Sync</span><span class="o">]</span> <span class="o">(</span><span class="n">client</span><span class="k">:</span> <span class="kt">Client</span><span class="o">[</span><span class="kt">F</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">L</span><span class="k">:</span> <span class="kt">TracerLog</span><span class="o">[</span><span class="kt">Trace</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">?</span><span class="o">]])</span> <span class="k">extends</span> <span class="nc">HttpClients</span><span class="o">[</span><span class="kt">Trace</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">?</span><span class="o">]]</span> <span class="o">{</span>
  <span class="k">private</span> <span class="k">val</span> <span class="n">clients</span> <span class="k">=</span> <span class="nc">LiveHttpClients</span><span class="o">[</span><span class="kt">F</span><span class="o">](</span><span class="n">client</span><span class="o">)</span>

  <span class="k">override</span> <span class="k">val</span> <span class="n">userRegistry</span><span class="k">:</span> <span class="kt">UserRegistry</span><span class="o">[</span><span class="kt">Trace</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">?</span><span class="o">]]</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">TracedUserRegistry</span><span class="o">[</span><span class="kt">F</span><span class="o">](</span><span class="n">clients</span><span class="o">.</span><span class="n">userRegistry</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="traced-programs">Traced Programs</h4>

<p>We again extend <code class="highlighter-rouge">Programs[Trace[F, ?]]</code> but in this case we receive other tracer interpreters as parameters:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">final</span> <span class="k">class</span> <span class="nc">UserTracer</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Sync</span><span class="o">](</span><span class="n">users</span><span class="k">:</span> <span class="kt">UserAlgebra</span><span class="o">[</span><span class="kt">Trace</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">?</span><span class="o">]])(</span><span class="k">implicit</span> <span class="n">L</span><span class="k">:</span> <span class="kt">TracerLog</span><span class="o">[</span><span class="kt">Trace</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">?</span><span class="o">]])</span> <span class="k">extends</span> <span class="nc">UserAlgebra</span><span class="o">[</span><span class="kt">Trace</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">?</span><span class="o">]]</span> <span class="o">{</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">find</span><span class="o">(</span><span class="n">username</span><span class="k">:</span> <span class="kt">Username</span><span class="o">)</span><span class="k">:</span> <span class="kt">Trace</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">User</span><span class="o">]</span> <span class="k">=</span>
    <span class="n">L</span><span class="o">.</span><span class="n">info</span><span class="o">[</span><span class="kt">UserAlgebra</span><span class="o">[</span><span class="kt">F</span><span class="o">]](</span><span class="n">s</span><span class="s">"Find user by username: ${username.value}"</span><span class="o">)</span> <span class="o">*&gt;</span> <span class="n">users</span><span class="o">.</span><span class="n">find</span><span class="o">(</span><span class="n">username</span><span class="o">)</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">persist</span><span class="o">(</span><span class="n">user</span><span class="k">:</span> <span class="kt">User</span><span class="o">)</span><span class="k">:</span> <span class="kt">Trace</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
    <span class="n">L</span><span class="o">.</span><span class="n">info</span><span class="o">[</span><span class="kt">UserAlgebra</span><span class="o">[</span><span class="kt">F</span><span class="o">]](</span><span class="n">s</span><span class="s">"About to persist user: ${user.username.value}"</span><span class="o">)</span> <span class="o">*&gt;</span> <span class="n">users</span><span class="o">.</span><span class="n">persist</span><span class="o">(</span><span class="n">user</span><span class="o">)</span>

<span class="o">}</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">TracedPrograms</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Par:</span> <span class="kt">Sync</span><span class="o">](</span><span class="n">repos</span><span class="k">:</span> <span class="kt">TracedRepositories</span><span class="o">[</span><span class="kt">F</span><span class="o">],</span> <span class="n">clients</span><span class="k">:</span> <span class="kt">TracedHttpClients</span><span class="o">[</span><span class="kt">F</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">L</span><span class="k">:</span> <span class="kt">TracerLog</span><span class="o">[</span><span class="kt">Trace</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">?</span><span class="o">]])</span> <span class="k">extends</span> <span class="nc">Programs</span><span class="o">[</span><span class="kt">Trace</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">?</span><span class="o">]]</span> <span class="o">{</span>
  <span class="k">private</span> <span class="k">val</span> <span class="n">programs</span> <span class="k">=</span> <span class="nc">LivePrograms</span><span class="o">[</span><span class="kt">Trace</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">?</span><span class="o">]](</span><span class="n">repos</span><span class="o">,</span> <span class="n">clients</span><span class="o">)</span>

  <span class="k">override</span> <span class="k">val</span> <span class="n">users</span><span class="k">:</span> <span class="kt">UserAlgebra</span><span class="o">[</span><span class="kt">Trace</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">?</span><span class="o">]]</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">UserTracer</span><span class="o">[</span><span class="kt">F</span><span class="o">](</span><span class="n">programs</span><span class="o">.</span><span class="n">users</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<p>You might have noticed that the approach used in <code class="highlighter-rouge">TracedPrograms</code> is different from the one in <code class="highlighter-rouge">TracedHttpClients</code> and <code class="highlighter-rouge">TracedRepositories</code>. The reason is that the last two are at the bottom of the graph so they can be created based on a simple effectful interpreter <code class="highlighter-rouge">F</code> whereas <code class="highlighter-rouge">TracedPrograms</code> is one level up and needs to have the tracer instances of such components.</p>

<p>Writing these tracers is the most tedious part as we need to write quite some boilerplate but this is the trade-off for getting nice distributed tracing logs.</p>

<h3 id="putting-all-the-pieces-together">Putting all the pieces together</h3>

<h4 id="main-entry-point">Main entry point</h4>

<p>This is where we instantiate our modules and create our <code class="highlighter-rouge">Tracer</code> instance. For a default instance with header name “Trace-Id” just use <code class="highlighter-rouge">import dev.profunktor.tracer.instances.tracer._</code>.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">dev.profunktor.tracer.instances.tracer._</span>
<span class="k">import</span> <span class="nn">dev.profunktor.tracer.instances.tracerlog._</span>
<span class="k">import</span> <span class="nn">org.http4s.client.blaze.BlazeClientBuilder</span>
<span class="k">import</span> <span class="nn">org.http4s.server.blaze.BlazeServerBuilder</span>
<span class="k">import</span> <span class="nn">scala.concurrent.ExecutionContext</span>

<span class="k">class</span> <span class="nc">Main</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">ConcurrentEffect:</span> <span class="kt">Par:</span> <span class="kt">Timer</span><span class="o">]</span> <span class="o">{</span>

  <span class="k">val</span> <span class="n">server</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">BlazeClientBuilder</span><span class="o">[</span><span class="kt">F</span><span class="o">](</span><span class="nc">ExecutionContext</span><span class="o">.</span><span class="n">global</span><span class="o">).</span><span class="n">resource</span><span class="o">.</span><span class="n">use</span> <span class="o">{</span> <span class="n">client</span> <span class="k">=&gt;</span>
      <span class="k">for</span> <span class="o">{</span>
        <span class="n">repos</span>          <span class="k">&lt;-</span> <span class="nc">LiveRepositories</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span>
        <span class="n">tracedRepos</span>    <span class="k">=</span> <span class="nc">TracedRepositories</span><span class="o">[</span><span class="kt">F</span><span class="o">](</span><span class="n">repos</span><span class="o">)</span>
        <span class="n">tracedClients</span>  <span class="k">=</span> <span class="nc">TracedHttpClients</span><span class="o">[</span><span class="kt">F</span><span class="o">](</span><span class="n">client</span><span class="o">)</span>
        <span class="n">tracedPrograms</span> <span class="k">=</span> <span class="nc">TracedPrograms</span><span class="o">[</span><span class="kt">F</span><span class="o">](</span><span class="n">tracedRepos</span><span class="o">,</span> <span class="n">tracedClients</span><span class="o">)</span>
        <span class="n">httpApi</span>        <span class="k">=</span> <span class="nc">HttpApi</span><span class="o">[</span><span class="kt">F</span><span class="o">](</span><span class="n">tracedPrograms</span><span class="o">)</span>
        <span class="k">_</span> <span class="k">&lt;-</span> <span class="nc">BlazeServerBuilder</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span>
              <span class="o">.</span><span class="n">bindHttp</span><span class="o">(</span><span class="mi">8080</span><span class="o">,</span> <span class="s">"0.0.0.0"</span><span class="o">)</span>
              <span class="o">.</span><span class="n">withHttpApp</span><span class="o">(</span><span class="n">httpApi</span><span class="o">.</span><span class="n">httpApp</span><span class="o">)</span>
              <span class="o">.</span><span class="n">serve</span>
              <span class="o">.</span><span class="n">compile</span>
              <span class="o">.</span><span class="n">drain</span>
      <span class="o">}</span> <span class="k">yield</span> <span class="o">()</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<h4 id="logger">Logger</h4>

<p>Note that we can get a default instance of <code class="highlighter-rouge">TracerLog</code> if our effect type has an instance of <code class="highlighter-rouge">Sync</code> by a single import.</p>

<p>If you are a <a href="https://christopherdavenport.github.io/log4cats/">log4cats</a> user we can derive a <code class="highlighter-rouge">TracerLog</code> instance if you provide a <code class="highlighter-rouge">Logger</code> instance. All you have to do is to import <code class="highlighter-rouge">dev.profunktor.tracer.log4cats._</code> and add the extra dependency <code class="highlighter-rouge">http4s-tracer-log4cats</code>. See the <a href="https://github.com/gvolpe/http4s-tracer/blob/master/examples/src/main/scala/dev.profunktor/tracer/Log4CatsServer.scala">Log4CatsServer</a> example for more.</p>

<h4 id="choose-your-effect-type">Choose your effect type!</h4>

<p>Here we are going to be using <code class="highlighter-rouge">cats.effect.IO</code> but you could use your own effect.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">object</span> <span class="nc">Server</span> <span class="k">extends</span> <span class="nc">IOApp</span> <span class="o">{</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">run</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">ExitCode</span><span class="o">]</span> <span class="k">=</span>
    <span class="k">new</span> <span class="nc">Main</span><span class="o">[</span><span class="kt">IO</span><span class="o">].</span><span class="n">server</span><span class="o">.</span><span class="n">as</span><span class="o">(</span><span class="nc">ExitCode</span><span class="o">.</span><span class="nc">Success</span><span class="o">)</span>

<span class="o">}</span>
</code></pre></div></div>

<h3 id="running-the-application">Running the application</h3>

<p>This is how the activity log might look like for a simple POST request (logging activated):</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>18:02:25.366 <span class="o">[</span>blaze-selector-0-2] INFO  o.h.b.c.nio1.NIO1SocketServerGroup - Accepted connection from /0:0:0:0:0:0:0:1:58284
18:02:25.375 <span class="o">[</span>ec-1] INFO  dev.profunktor.tracer.Tracer - <span class="o">[</span>Trace-Id] - <span class="o">[</span>6cb069c0-2792-11e9-9038-b9bcfc32f88f] - Request<span class="o">(</span><span class="nv">method</span><span class="o">=</span>POST, <span class="nv">uri</span><span class="o">=</span>/users, <span class="nv">headers</span><span class="o">=</span>Headers<span class="o">(</span>HOST: localhost:8080, content-type: application/json, content-length: 8<span class="o">))</span>
18:02:25.527 <span class="o">[</span>ec-1] INFO  d.p.tracer.algebra.UserAlgebra - <span class="o">[</span>Trace-Id] - <span class="o">[</span>6cb069c0-2792-11e9-9038-b9bcfc32f88f] - About to persist user: gvolpe
18:02:25.527 <span class="o">[</span>ec-1] INFO  d.p.t.r.algebra<span class="nv">$UserRepository</span> - <span class="o">[</span>Trace-Id] - <span class="o">[</span>6cb069c0-2792-11e9-9038-b9bcfc32f88f] - Find user by username: gvolpe
18:02:25.540 <span class="o">[</span>ec-1] INFO  d.p.t.http.client.UserRegistry - <span class="o">[</span>Trace-Id] - <span class="o">[</span>6cb069c0-2792-11e9-9038-b9bcfc32f88f] - Registering user: gvolpe
18:02:25.540 <span class="o">[</span>ec-1] INFO  d.p.t.r.algebra<span class="nv">$UserRepository</span> - <span class="o">[</span>Trace-Id] - <span class="o">[</span>6cb069c0-2792-11e9-9038-b9bcfc32f88f] - Persisting user: gvolpe
18:02:26.601 <span class="o">[</span>ec-1] INFO  dev.profunktor.tracer.Tracer - <span class="o">[</span>Trace-Id] - <span class="o">[</span>6cb069c0-2792-11e9-9038-b9bcfc32f88f] - Response<span class="o">(</span><span class="nv">status</span><span class="o">=</span>201, <span class="nv">headers</span><span class="o">=</span>Headers<span class="o">(</span>Content-Length: 0, Flow-Id: 6cb069c0-2792-11e9-9038-b9bcfc32f88f<span class="o">))</span>
</code></pre></div></div>

<p>Quite useful to trace the flow of your application starting out at each request. In a normal application, you will have thousands of requests and tracing the call-chain in a failure scenario will be invaluable.</p>

<h3 id="source-code">Source code</h3>

<p>This documentation is compiled with <a href="http://tpolecat.github.io/tut/">tut</a> to guarantee it’s always updated. However, it is always easier to have a project you can import and easily run so we’ve got you covered!</p>

<p>Find the source code in the <a href="https://github.com/gvolpe/http4s-tracer/tree/master/examples/src">examples module</a>.</p>

</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/highlight/highlight.pack.js"></script><script>hljs.configure({languages:['scala','java','bash']});
hljs.initHighlighting();
              </script><script src="/js/toc.js"></script><script>((window.gitter = {}).chat = {}).options = {
room: 'http4s-tracer/http4s-tracer'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script><script src="/js/main.js"></script></body></html>