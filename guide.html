<html><head><title>Http4s Tracer: Guide</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Gabriel Volpe" /><meta name="description" content="End-to-end tracing system for Http4s" /><meta name="og:image" content="/http4s-tracer/img/poster.png" /><meta name="og:title" content="Http4s Tracer: Guide" /><meta name="og:site_name" content="Http4s Tracer" /><meta name="og:url" content="https://github.com/gvolpe/http4s-tracer" /><meta name="og:type" content="website" /><meta name="og:description" content="End-to-end tracing system for Http4s" /><link rel="icon" type="image/png" href="/http4s-tracer/img/favicon.png" /><meta name="twitter:title" content="Http4s Tracer: Guide" /><meta name="twitter:image" content="https://github.com/gvolpe/http4s-tracerimg/poster.png" /><meta name="twitter:description" content="End-to-end tracing system for Http4s" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/http4s-tracer/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/http4s-tracer/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/http4s-tracer/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/http4s-tracer/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/http4s-tracer/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/http4s-tracer/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/http4s-tracer/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/http4s-tracer/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/http4s-tracer/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/http4s-tracer/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/http4s-tracer/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/http4s-tracer/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/http4s-tracer/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/http4s-tracer/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/http4s-tracer/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/http4s-tracer/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/http4s-tracer/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/http4s-tracer/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/http4s-tracer/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/http4s-tracer/img/favicon310x150.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/http4s-tracer/highlight/styles/default.css" /><link rel="stylesheet" href="/http4s-tracer/css/style.css" /><link rel="stylesheet" href="/http4s-tracer/css/palette.css" /><link rel="stylesheet" href="/http4s-tracer/css/codemirror.css" /><link rel="stylesheet" href="/http4s-tracer/css/toc.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/http4s-tracer/" class="brand"><div class="brand-wrapper"><span>Http4s Tracer</span></div></a></li> <li><a href="/http4s-tracer/overview.html" class="">Overview</a></li> <li><a href="/http4s-tracer/motivations.html" class="">Motivations</a></li> <li><a href="/http4s-tracer/guide.html" class=" active ">Guide</a></li></ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/gvolpe/http4s-tracer"><i class="fa fa-eye"></i><span>WATCH<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/gvolpe/http4s-tracer"><i class="fa fa-star-o"></i><span>STARS<span id="stars" class="label label-default">--</span></span></a></li><li><a href="#" onclick="shareSiteTwitter('Http4s Tracer End-to-end tracing system for Http4s');"><i class="fa fa-twitter"></i></a></li><li><a href="#" onclick="shareSiteFacebook('Http4s Tracer End-to-end tracing system for Http4s');"><i class="fa fa-facebook"></i></a></li><li><a href="#" onclick="shareSiteGoogle();"><i class="fa fa-google-plus"></i></a></li></ul></div></div></div></div><div id="content" data-github-owner="gvolpe" data-github-repo="http4s-tracer"><div class="content-wrapper"><section><h1 id="a-guide-to-a-complete-application-using-http4s-tracer">A guide to a complete application using Http4s Tracer</h1>

<p>The following example will follow a (recommended) <a href="http://okmij.org/ftp/tagless-final/index.html">tagless final</a> encoding:</p>

<nav role="navigation" id="toc"></nav>

<h3 id="tagless-final-application">Tagless final application</h3>

<h4 id="domain-model--errors">Domain model &amp; Errors</h4>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">Username</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">AnyVal</span>
<span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">User</span><span class="o">(</span><span class="n">username</span><span class="k">:</span> <span class="kt">Username</span><span class="o">)</span>

<span class="k">sealed</span> <span class="k">trait</span> <span class="nc">UserError</span> <span class="k">extends</span> <span class="nc">Exception</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">UserAlreadyExists</span><span class="o">(</span><span class="n">username</span><span class="k">:</span> <span class="kt">Username</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">UserError</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">UserNotFound</span><span class="o">(</span><span class="n">username</span><span class="k">:</span> <span class="kt">Username</span><span class="o">)</span>      <span class="k">extends</span> <span class="nc">UserError</span>
</code></pre></div></div>

<h4 id="algebras">Algebras</h4>

<p>Also known as interfaces, they define the functionality we want to expose and we will only operate in terms of these definitions:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">trait</span> <span class="nc">UserAlgebra</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">find</span><span class="o">(</span><span class="n">username</span><span class="k">:</span> <span class="kt">Username</span><span class="o">)</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">User</span><span class="o">]</span>
  <span class="k">def</span> <span class="n">persist</span><span class="o">(</span><span class="n">user</span><span class="k">:</span> <span class="kt">User</span><span class="o">)</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span>
<span class="o">}</span>

<span class="k">trait</span> <span class="nc">UserRepository</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">find</span><span class="o">(</span><span class="n">username</span><span class="k">:</span> <span class="kt">Username</span><span class="o">)</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">Option</span><span class="o">[</span><span class="kt">User</span><span class="o">]]</span>
  <span class="k">def</span> <span class="n">persist</span><span class="o">(</span><span class="n">user</span><span class="k">:</span> <span class="kt">User</span><span class="o">)</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="programs">Programs</h4>

<p>Contains pure logic. It can possiby combine multiple algebras as well as other programs but without commiting to a specific implementation:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.MonadError</span>
<span class="k">import</span> <span class="nn">cats.implicits._</span>

<span class="k">class</span> <span class="nc">UserProgram</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]](</span><span class="n">repo</span><span class="k">:</span> <span class="kt">UserRepository</span><span class="o">[</span><span class="kt">F</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">F</span><span class="k">:</span> <span class="kt">MonadError</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Throwable</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">UserAlgebra</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span> <span class="o">{</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">find</span><span class="o">(</span><span class="n">username</span><span class="k">:</span> <span class="kt">Username</span><span class="o">)</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">User</span><span class="o">]</span> <span class="k">=</span>
    <span class="k">for</span> <span class="o">{</span>
      <span class="n">mu</span> <span class="k">&lt;-</span> <span class="n">repo</span><span class="o">.</span><span class="n">find</span><span class="o">(</span><span class="n">username</span><span class="o">)</span>
      <span class="n">rs</span> <span class="k">&lt;-</span> <span class="n">mu</span><span class="o">.</span><span class="n">fold</span><span class="o">(</span><span class="n">F</span><span class="o">.</span><span class="n">raiseError</span><span class="o">[</span><span class="kt">User</span><span class="o">](</span><span class="nc">UserNotFound</span><span class="o">(</span><span class="n">username</span><span class="o">)))(</span><span class="n">F</span><span class="o">.</span><span class="n">pure</span><span class="o">)</span>
    <span class="o">}</span> <span class="k">yield</span> <span class="n">rs</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">persist</span><span class="o">(</span><span class="n">user</span><span class="k">:</span> <span class="kt">User</span><span class="o">)</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
    <span class="k">for</span> <span class="o">{</span>
      <span class="n">mu</span> <span class="k">&lt;-</span> <span class="n">repo</span><span class="o">.</span><span class="n">find</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="o">)</span>
      <span class="n">rs</span> <span class="k">&lt;-</span> <span class="n">mu</span><span class="o">.</span><span class="n">fold</span><span class="o">(</span><span class="n">repo</span><span class="o">.</span><span class="n">persist</span><span class="o">(</span><span class="n">user</span><span class="o">))(</span><span class="k">_</span> <span class="k">=&gt;</span> <span class="n">F</span><span class="o">.</span><span class="n">raiseError</span><span class="o">(</span><span class="nc">UserAlreadyExists</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="o">)))</span>
    <span class="o">}</span> <span class="k">yield</span> <span class="n">rs</span>

<span class="o">}</span>
</code></pre></div></div>

<h4 id="interpreters">Interpreters</h4>

<p>In this case we will only have a single interpreter for our <code class="highlighter-rouge">Repository</code>: an in-memory implementation based on <code class="highlighter-rouge">Ref</code>.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.effect._</span>
<span class="k">import</span> <span class="nn">cats.effect.concurrent.Ref</span>

<span class="k">class</span> <span class="nc">MemUserRepository</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Sync</span><span class="o">]</span> <span class="o">(</span>
    <span class="n">state</span><span class="k">:</span> <span class="kt">Ref</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Map</span><span class="o">[</span><span class="kt">Username</span>, <span class="kt">User</span><span class="o">]]</span>
<span class="o">)</span> <span class="k">extends</span> <span class="nc">UserRepository</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span> <span class="o">{</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">find</span><span class="o">(</span><span class="n">username</span><span class="k">:</span> <span class="kt">Username</span><span class="o">)</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">Option</span><span class="o">[</span><span class="kt">User</span><span class="o">]]</span> <span class="k">=</span>
    <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">username</span><span class="o">))</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">persist</span><span class="o">(</span><span class="n">user</span><span class="k">:</span> <span class="kt">User</span><span class="o">)</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
    <span class="n">state</span><span class="o">.</span><span class="n">update</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">updated</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="o">,</span> <span class="n">user</span><span class="o">))</span>

<span class="o">}</span>

<span class="k">object</span> <span class="nc">MemUserRepository</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">create</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Sync</span><span class="o">]</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">UserRepository</span><span class="o">[</span><span class="kt">F</span><span class="o">]]</span> <span class="k">=</span>
    <span class="nc">Ref</span><span class="o">.</span><span class="n">of</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Map</span><span class="o">[</span><span class="kt">Username</span>, <span class="kt">User</span><span class="o">]](</span><span class="nc">Map</span><span class="o">.</span><span class="n">empty</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="k">new</span> <span class="nc">MemUserRepository</span><span class="o">[</span><span class="kt">F</span><span class="o">](</span><span class="k">_</span><span class="o">))</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="distributed-tracing">Distributed Tracing</h3>

<p>Note that until here we have only defined <code class="highlighter-rouge">algebras</code>, <code class="highlighter-rouge">programs</code> and <code class="highlighter-rouge">interpreters</code> that can easily be tested in isolation. No tracing concepts so far. And as mentioned in the overview section, the <code class="highlighter-rouge">HttpRoutes</code> should only be aware of it but we’ll also need some tracer interpreters and we will soon see what this means.</p>

<h4 id="http-routes">Http Routes</h4>

<p>We need to defined some codecs first that can be used by all our <code class="highlighter-rouge">HttpRoutes</code>:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">io.circe.</span><span class="o">{</span><span class="nc">Decoder</span><span class="o">,</span> <span class="nc">Encoder</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">io.circe.generic.extras.decoding.UnwrappedDecoder</span>
<span class="k">import</span> <span class="nn">io.circe.generic.extras.encoding.UnwrappedEncoder</span>
<span class="k">import</span> <span class="nn">org.http4s._</span>
<span class="k">import</span> <span class="nn">org.http4s.circe._</span>

<span class="k">implicit</span> <span class="k">def</span> <span class="n">valueClassEncoder</span><span class="o">[</span><span class="kt">A:</span> <span class="kt">UnwrappedEncoder</span><span class="o">]</span><span class="k">:</span> <span class="kt">Encoder</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="n">implicitly</span>
<span class="k">implicit</span> <span class="k">def</span> <span class="n">valueClassDecoder</span><span class="o">[</span><span class="kt">A:</span> <span class="kt">UnwrappedDecoder</span><span class="o">]</span><span class="k">:</span> <span class="kt">Decoder</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="n">implicitly</span>

<span class="k">implicit</span> <span class="k">def</span> <span class="n">jsonDecoder</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Sync</span>, <span class="kt">A</span> <span class="k">&lt;:</span> <span class="kt">Product:</span> <span class="kt">Decoder</span><span class="o">]</span><span class="k">:</span> <span class="kt">EntityDecoder</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="n">jsonOf</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">A</span><span class="o">]</span>
<span class="k">implicit</span> <span class="k">def</span> <span class="n">jsonEncoder</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Sync</span>, <span class="kt">A</span> <span class="k">&lt;:</span> <span class="kt">Product:</span> <span class="kt">Encoder</span><span class="o">]</span><span class="k">:</span> <span class="kt">EntityEncoder</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="n">jsonEncoderOf</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">A</span><span class="o">]</span>
</code></pre></div></div>

<p>Use <code class="highlighter-rouge">Http4sTracerDsl[F]</code> and <code class="highlighter-rouge">TracedHttpRoute</code> instead of <code class="highlighter-rouge">Http4sDsl[F]</code> and <code class="highlighter-rouge">HttpRoutes.of[F]</code> respectively.</p>

<p><em>For authenticated routes use <code class="highlighter-rouge">Http4sAuthTracerDsl[F]</code> and <code class="highlighter-rouge">AuthTracedHttpRoute[T, F]</code> instead.</em></p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">com.github.gvolpe.tracer.Trace._</span>
<span class="k">import</span> <span class="nn">com.github.gvolpe.tracer.</span><span class="o">{</span><span class="nc">Http4sTracerDsl</span><span class="o">,</span> <span class="nc">TracedHttpRoute</span><span class="o">,</span> <span class="nc">Tracer</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">io.circe.generic.auto._</span>
<span class="k">import</span> <span class="nn">org.http4s.server.Router</span>

<span class="k">class</span> <span class="nc">UserRoutes</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Sync:</span> <span class="kt">Tracer</span><span class="o">](</span><span class="n">users</span><span class="k">:</span> <span class="kt">UserAlgebra</span><span class="o">[</span><span class="kt">Trace</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">?</span><span class="o">]])</span> <span class="k">extends</span> <span class="nc">Http4sTracerDsl</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span> <span class="o">{</span>

  <span class="k">private</span> <span class="k">val</span> <span class="nc">PathPrefix</span> <span class="k">=</span> <span class="s">"/users"</span>

  <span class="k">private</span> <span class="k">val</span> <span class="n">httpRoutes</span><span class="k">:</span> <span class="kt">HttpRoutes</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span> <span class="k">=</span> <span class="nc">TracedHttpRoute</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">GET</span> <span class="o">-&gt;</span> <span class="nc">Root</span> <span class="o">/</span> <span class="n">username</span> <span class="n">using</span> <span class="n">traceId</span> <span class="k">=&gt;</span>
      <span class="n">users</span>
        <span class="o">.</span><span class="n">find</span><span class="o">(</span><span class="nc">Username</span><span class="o">(</span><span class="n">username</span><span class="o">))</span>
        <span class="o">.</span><span class="n">run</span><span class="o">(</span><span class="n">traceId</span><span class="o">)</span>
        <span class="o">.</span><span class="n">flatMap</span><span class="o">(</span><span class="n">user</span> <span class="k">=&gt;</span> <span class="nc">Ok</span><span class="o">(</span><span class="n">user</span><span class="o">))</span>
        <span class="o">.</span><span class="n">handleErrorWith</span> <span class="o">{</span>
          <span class="k">case</span> <span class="nc">UserNotFound</span><span class="o">(</span><span class="n">u</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">NotFound</span><span class="o">(</span><span class="n">u</span><span class="o">.</span><span class="n">value</span><span class="o">)</span>
        <span class="o">}</span>

    <span class="k">case</span> <span class="n">tr</span> <span class="k">@</span> <span class="nc">POST</span> <span class="o">-&gt;</span> <span class="nc">Root</span> <span class="n">using</span> <span class="n">traceId</span> <span class="k">=&gt;</span>
      <span class="n">tr</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">decode</span><span class="o">[</span><span class="kt">User</span><span class="o">]</span> <span class="o">{</span> <span class="n">user</span> <span class="k">=&gt;</span>
        <span class="n">users</span>
          <span class="o">.</span><span class="n">persist</span><span class="o">(</span><span class="n">user</span><span class="o">)</span>
          <span class="o">.</span><span class="n">run</span><span class="o">(</span><span class="n">traceId</span><span class="o">)</span>
          <span class="o">.</span><span class="n">flatMap</span><span class="o">(</span><span class="k">_</span> <span class="k">=&gt;</span> <span class="nc">Created</span><span class="o">())</span>
          <span class="o">.</span><span class="n">handleErrorWith</span> <span class="o">{</span>
             <span class="k">case</span> <span class="nc">UserAlreadyExists</span><span class="o">(</span><span class="n">u</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Conflict</span><span class="o">(</span><span class="n">u</span><span class="o">.</span><span class="n">value</span><span class="o">)</span>
          <span class="o">}</span>
      <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">val</span> <span class="n">routes</span><span class="k">:</span> <span class="kt">HttpRoutes</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Router</span><span class="o">(</span>
    <span class="nc">PathPrefix</span> <span class="o">-&gt;</span> <span class="n">httpRoutes</span>
  <span class="o">)</span>

<span class="o">}</span>
</code></pre></div></div>

<p>There are a couple of things going on here:</p>

<ul>
  <li>We require an <code class="highlighter-rouge">UserAlgebra[Trace[F, ?]]</code> instead of a plain <code class="highlighter-rouge">UserAlgebra[F]</code>.</li>
  <li>We need an instance of <code class="highlighter-rouge">Tracer[F]</code> in scope to make sure we are getting the right header.</li>
</ul>

<p>This is necessary to pass the “Trace-Id” along and we’ll soon see how to do it.</p>

<h3 id="modules">Modules</h3>

<p>The recommended way to structure tagless final applications is to group things in different modules. For this simple application we will define three modules: <code class="highlighter-rouge">HttpApi</code>, <code class="highlighter-rouge">Programs</code> and <code class="highlighter-rouge">Repositories</code>. In a larger application we might have more modules such as <code class="highlighter-rouge">HttpClients</code>, etc. The idea will remain the same.</p>

<h4 id="programs-module">Programs module</h4>

<p>This module is going to be the “master algebra” that groups all the single algebras.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">trait</span> <span class="nc">Programs</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">users</span><span class="k">:</span> <span class="kt">UserAlgebra</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="repositories-module">Repositories module</h4>

<p>In the same way, this is the “master algebra of repositories”. And in addition, we provide a way of creating the in-memory interpreter since its creation is effectful.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">trait</span> <span class="nc">Repositories</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">users</span><span class="k">:</span> <span class="kt">UserRepository</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">LiveRepositories</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]](</span><span class="n">usersRepo</span><span class="k">:</span> <span class="kt">UserRepository</span><span class="o">[</span><span class="kt">F</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">Repositories</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">users</span><span class="k">:</span> <span class="kt">UserRepository</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span> <span class="k">=</span> <span class="n">usersRepo</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">LiveRepositories</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">apply</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Sync</span><span class="o">]</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">Repositories</span><span class="o">[</span><span class="kt">F</span><span class="o">]]</span> <span class="k">=</span>
    <span class="nc">MemUserRepository</span><span class="o">.</span><span class="n">create</span><span class="o">[</span><span class="kt">F</span><span class="o">].</span><span class="n">map</span><span class="o">(</span><span class="k">new</span> <span class="nc">LiveRepositories</span><span class="o">[</span><span class="kt">F</span><span class="o">](</span><span class="k">_</span><span class="o">))</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="httpapi-module">HttpApi module</h4>

<p>Before we look into the <code class="highlighter-rouge">HttpApi</code> module let’s look into the <code class="highlighter-rouge">middleware</code> signature:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="n">middleware</span><span class="o">(</span>
  <span class="n">http</span><span class="k">:</span> <span class="kt">HttpApp</span><span class="o">[</span><span class="kt">F</span><span class="o">],</span>
  <span class="n">logRequest</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="kc">false</span><span class="o">,</span>
  <span class="n">logResponse</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="kc">false</span>
<span class="o">)(</span><span class="k">implicit</span> <span class="n">F</span><span class="k">:</span> <span class="kt">Sync</span><span class="o">[</span><span class="kt">F</span><span class="o">],</span> <span class="n">L</span><span class="k">:</span> <span class="kt">TracerLog</span><span class="o">[</span><span class="kt">Trace</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">?</span><span class="o">]])</span><span class="k">:</span> <span class="kt">HttpApp</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
</code></pre></div></div>

<p>You can change the default values of the boolean flags if you want to have the request and/or response logged. If you want both activated there’s a another constructor provided by the library:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="n">loggingMiddleware</span><span class="o">(</span>
    <span class="n">http</span><span class="k">:</span> <span class="kt">HttpApp</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span>
<span class="o">)(</span><span class="k">implicit</span> <span class="n">F</span><span class="k">:</span> <span class="kt">Sync</span><span class="o">[</span><span class="kt">F</span><span class="o">],</span> <span class="n">L</span><span class="k">:</span> <span class="kt">TracerLog</span><span class="o">[</span><span class="kt">Trace</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">?</span><span class="o">]])</span><span class="k">:</span> <span class="kt">HttpApp</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span> <span class="k">=</span>
  <span class="n">middleware</span><span class="o">(</span><span class="n">http</span><span class="o">,</span> <span class="n">logRequest</span> <span class="k">=</span> <span class="kc">true</span><span class="o">,</span> <span class="n">logResponse</span> <span class="k">=</span> <span class="kc">true</span><span class="o">)</span>
</code></pre></div></div>

<p>Finally, here we define our <code class="highlighter-rouge">HttpRoutes</code> and tracing middleware.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">com.github.gvolpe.tracer.Trace.Trace</span>
<span class="k">import</span> <span class="nn">com.github.gvolpe.tracer.</span><span class="o">{</span><span class="nc">Tracer</span><span class="o">,</span> <span class="nc">TracerLog</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">org.http4s.implicits._</span>
<span class="k">import</span> <span class="nn">org.http4s.</span><span class="o">{</span><span class="nc">HttpApp</span><span class="o">,</span> <span class="nc">HttpRoutes</span><span class="o">}</span>

<span class="k">class</span> <span class="nc">HttpApi</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Sync:</span> <span class="kt">Tracer</span><span class="o">](</span><span class="n">programs</span><span class="k">:</span> <span class="kt">Programs</span><span class="o">[</span><span class="kt">Trace</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">?</span><span class="o">]])(</span><span class="k">implicit</span> <span class="n">L</span><span class="k">:</span> <span class="kt">TracerLog</span><span class="o">[</span><span class="kt">Trace</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">?</span><span class="o">]])</span> <span class="o">{</span>

  <span class="k">private</span> <span class="k">val</span> <span class="n">httpRoutes</span><span class="k">:</span> <span class="kt">HttpRoutes</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span> <span class="k">=</span>
    <span class="k">new</span> <span class="nc">UserRoutes</span><span class="o">[</span><span class="kt">F</span><span class="o">](</span><span class="n">programs</span><span class="o">.</span><span class="n">users</span><span class="o">).</span><span class="n">routes</span>

  <span class="k">val</span> <span class="n">httpApp</span><span class="k">:</span> <span class="kt">HttpApp</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">Tracer</span><span class="o">[</span><span class="kt">F</span><span class="o">].</span><span class="n">middleware</span><span class="o">(</span><span class="n">httpRoutes</span><span class="o">.</span><span class="n">orNotFound</span><span class="o">)</span>

<span class="o">}</span>
</code></pre></div></div>

<p>Note that we again require a <code class="highlighter-rouge">Programs[Trace[F, ?]]</code> instead of just <code class="highlighter-rouge">Programs[F]</code> and also an instance of <code class="highlighter-rouge">TracerLog[Trace[F, ?]]</code> required by <code class="highlighter-rouge">Tracer[F].middleware</code>.</p>

<h3 id="tracers">Tracers</h3>

<p>Now that we have defined our program, http routes and modules it’s time to introduce the “tracers”. These are just interpreters with tracing capabilities written on top of our “group modules”. Let’s see the code.</p>

<h4 id="traced-programs">Traced Programs</h4>

<p>We extend <code class="highlighter-rouge">Programs</code> with our effect type being <code class="highlighter-rouge">Trace[F, ?]</code> and define all the different algebras.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">com.github.gvolpe.tracer.Trace</span>
<span class="k">import</span> <span class="nn">com.github.gvolpe.tracer.Trace.Trace</span>
<span class="k">import</span> <span class="nn">com.github.gvolpe.tracer.TracerLog</span>

<span class="k">class</span> <span class="nc">UserTracer</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Sync</span><span class="o">](</span><span class="n">repo</span><span class="k">:</span> <span class="kt">UserRepository</span><span class="o">[</span><span class="kt">Trace</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">?</span><span class="o">]])(</span><span class="k">implicit</span> <span class="n">L</span><span class="k">:</span> <span class="kt">TracerLog</span><span class="o">[</span><span class="kt">Trace</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">?</span><span class="o">]])</span> <span class="k">extends</span> <span class="nc">UserProgram</span><span class="o">[</span><span class="kt">Trace</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">?</span><span class="o">]](</span><span class="n">repo</span><span class="o">)</span> <span class="o">{</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">find</span><span class="o">(</span><span class="n">username</span><span class="k">:</span> <span class="kt">Username</span><span class="o">)</span><span class="k">:</span> <span class="kt">Trace</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">User</span><span class="o">]</span> <span class="k">=</span>
    <span class="k">for</span> <span class="o">{</span>
      <span class="k">_</span> <span class="k">&lt;-</span> <span class="n">L</span><span class="o">.</span><span class="n">info</span><span class="o">[</span><span class="kt">UserAlgebra</span><span class="o">[</span><span class="kt">F</span><span class="o">]](</span><span class="n">s</span><span class="s">"Find user by username: ${username.value}"</span><span class="o">)</span>
      <span class="n">u</span> <span class="k">&lt;-</span> <span class="k">super</span><span class="o">.</span><span class="n">find</span><span class="o">(</span><span class="n">username</span><span class="o">)</span>
    <span class="o">}</span> <span class="k">yield</span> <span class="n">u</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">persist</span><span class="o">(</span><span class="n">user</span><span class="k">:</span> <span class="kt">User</span><span class="o">)</span><span class="k">:</span> <span class="kt">Trace</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
    <span class="k">for</span> <span class="o">{</span>
      <span class="k">_</span>  <span class="k">&lt;-</span> <span class="n">L</span><span class="o">.</span><span class="n">info</span><span class="o">[</span><span class="kt">UserAlgebra</span><span class="o">[</span><span class="kt">F</span><span class="o">]](</span><span class="n">s</span><span class="s">"About to persist user: ${user.username.value}"</span><span class="o">)</span>
      <span class="n">rs</span> <span class="k">&lt;-</span> <span class="k">super</span><span class="o">.</span><span class="n">persist</span><span class="o">(</span><span class="n">user</span><span class="o">)</span>
    <span class="o">}</span> <span class="k">yield</span> <span class="n">rs</span>

<span class="o">}</span>

<span class="k">class</span> <span class="nc">TracedPrograms</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Sync</span><span class="o">](</span><span class="n">repos</span><span class="k">:</span> <span class="kt">Repositories</span><span class="o">[</span><span class="kt">Trace</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">?</span><span class="o">]])(</span><span class="k">implicit</span> <span class="n">L</span><span class="k">:</span> <span class="kt">TracerLog</span><span class="o">[</span><span class="kt">Trace</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">?</span><span class="o">]])</span> <span class="k">extends</span> <span class="nc">Programs</span><span class="o">[</span><span class="kt">Trace</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">?</span><span class="o">]]</span> <span class="o">{</span>
  <span class="k">override</span> <span class="k">val</span> <span class="n">users</span><span class="k">:</span> <span class="kt">UserAlgebra</span><span class="o">[</span><span class="kt">Trace</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">?</span><span class="o">]]</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">UserTracer</span><span class="o">[</span><span class="kt">F</span><span class="o">](</span><span class="n">repos</span><span class="o">.</span><span class="n">users</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<p>In this case we only have one, so we just extend <code class="highlighter-rouge">UserProgram</code> and write tracing logs on top of it. This is just an
interpreter that adds tracing capabilities on top of the original program, highly decoupled.</p>

<h4 id="traced-repositories">Traced Repositories</h4>

<p>Again we extend <code class="highlighter-rouge">Repositories[Trace[F, ?]]</code> and provide the necessary tracing interpreters.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.FlatMap</span>

<span class="k">class</span> <span class="nc">UserTracerRepository</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">FlatMap</span><span class="o">](</span><span class="n">repo</span><span class="k">:</span> <span class="kt">UserRepository</span><span class="o">[</span><span class="kt">F</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">L</span><span class="k">:</span> <span class="kt">TracerLog</span><span class="o">[</span><span class="kt">Trace</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">?</span><span class="o">]])</span> <span class="k">extends</span> <span class="nc">UserRepository</span><span class="o">[</span><span class="kt">Trace</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">?</span><span class="o">]]</span> <span class="o">{</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">find</span><span class="o">(</span><span class="n">username</span><span class="k">:</span> <span class="kt">Username</span><span class="o">)</span><span class="k">:</span> <span class="kt">Trace</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Option</span><span class="o">[</span><span class="kt">User</span><span class="o">]]</span> <span class="k">=</span>
    <span class="k">for</span> <span class="o">{</span>
      <span class="k">_</span> <span class="k">&lt;-</span> <span class="n">L</span><span class="o">.</span><span class="n">info</span><span class="o">[</span><span class="kt">UserRepository</span><span class="o">[</span><span class="kt">F</span><span class="o">]](</span><span class="n">s</span><span class="s">"Find user by username: ${username.value}"</span><span class="o">)</span>
      <span class="n">u</span> <span class="k">&lt;-</span> <span class="nc">Trace</span><span class="o">(</span><span class="k">_</span> <span class="k">=&gt;</span> <span class="n">repo</span><span class="o">.</span><span class="n">find</span><span class="o">(</span><span class="n">username</span><span class="o">))</span>
    <span class="o">}</span> <span class="k">yield</span> <span class="n">u</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">persist</span><span class="o">(</span><span class="n">user</span><span class="k">:</span> <span class="kt">User</span><span class="o">)</span><span class="k">:</span> <span class="kt">Trace</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
    <span class="k">for</span> <span class="o">{</span>
      <span class="k">_</span> <span class="k">&lt;-</span> <span class="n">L</span><span class="o">.</span><span class="n">info</span><span class="o">[</span><span class="kt">UserRepository</span><span class="o">[</span><span class="kt">F</span><span class="o">]](</span><span class="n">s</span><span class="s">"Persisting user: ${user.username.value}"</span><span class="o">)</span>
      <span class="k">_</span> <span class="k">&lt;-</span> <span class="nc">Trace</span><span class="o">(</span><span class="k">_</span> <span class="k">=&gt;</span> <span class="n">repo</span><span class="o">.</span><span class="n">persist</span><span class="o">(</span><span class="n">user</span><span class="o">))</span>
    <span class="o">}</span> <span class="k">yield</span> <span class="o">()</span>

<span class="o">}</span>

<span class="k">class</span> <span class="nc">TracedRepositories</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">FlatMap</span><span class="o">](</span><span class="n">repos</span><span class="k">:</span> <span class="kt">Repositories</span><span class="o">[</span><span class="kt">F</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">L</span><span class="k">:</span> <span class="kt">TracerLog</span><span class="o">[</span><span class="kt">Trace</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">?</span><span class="o">]])</span> <span class="k">extends</span> <span class="nc">Repositories</span><span class="o">[</span><span class="kt">Trace</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">?</span><span class="o">]]</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">users</span><span class="k">:</span> <span class="kt">UserRepository</span><span class="o">[</span><span class="kt">Trace</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">?</span><span class="o">]]</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">UserTracerRepository</span><span class="o">[</span><span class="kt">F</span><span class="o">](</span><span class="n">repos</span><span class="o">.</span><span class="n">users</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Writing these tracers is the most tedious part as we need to write quite some boilerplate but this is the trade-off for getting nice distributed tracing logs.</p>

<h3 id="putting-all-the-pieces-together">Putting all the pieces together</h3>

<h4 id="main-entry-point">Main entry point</h4>

<p>This is where we instantiate our modules and create our <code class="highlighter-rouge">Tracer</code> instance. For a default instance with header name “Trace-Id” just use <code class="highlighter-rouge">import com.github.gvolpe.tracer.instances.tracer._</code>.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">com.github.gvolpe.tracer.instances.tracerlog._</span>
<span class="k">import</span> <span class="nn">org.http4s.server.blaze.BlazeServerBuilder</span>

<span class="k">class</span> <span class="nc">Main</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">ConcurrentEffect:</span> <span class="kt">Timer</span><span class="o">]</span> <span class="o">{</span>

  <span class="k">implicit</span> <span class="k">val</span> <span class="n">tracer</span><span class="k">:</span> <span class="kt">Tracer</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Tracer</span><span class="o">.</span><span class="n">create</span><span class="o">[</span><span class="kt">F</span><span class="o">](</span><span class="s">"Flow-Id"</span><span class="o">)</span>

  <span class="k">val</span> <span class="n">server</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">LiveRepositories</span><span class="o">[</span><span class="kt">F</span><span class="o">].</span><span class="n">flatMap</span> <span class="o">{</span> <span class="n">repositories</span> <span class="k">=&gt;</span>
      <span class="k">val</span> <span class="n">tracedRepos</span>    <span class="k">=</span> <span class="k">new</span> <span class="nc">TracedRepositories</span><span class="o">[</span><span class="kt">F</span><span class="o">](</span><span class="n">repositories</span><span class="o">)</span>
      <span class="k">val</span> <span class="n">tracedPrograms</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">TracedPrograms</span><span class="o">[</span><span class="kt">F</span><span class="o">](</span><span class="n">tracedRepos</span><span class="o">)</span>
      <span class="k">val</span> <span class="n">httpApi</span>        <span class="k">=</span> <span class="k">new</span> <span class="nc">HttpApi</span><span class="o">[</span><span class="kt">F</span><span class="o">](</span><span class="n">tracedPrograms</span><span class="o">)</span>

      <span class="nc">BlazeServerBuilder</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span>
        <span class="o">.</span><span class="n">bindHttp</span><span class="o">(</span><span class="mi">8080</span><span class="o">,</span> <span class="s">"0.0.0.0"</span><span class="o">)</span>
        <span class="o">.</span><span class="n">withHttpApp</span><span class="o">(</span><span class="n">httpApi</span><span class="o">.</span><span class="n">httpApp</span><span class="o">)</span>
        <span class="o">.</span><span class="n">serve</span>
        <span class="o">.</span><span class="n">compile</span>
        <span class="o">.</span><span class="n">drain</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<h4 id="logger">Logger</h4>

<p>Note that we can get a default instance of <code class="highlighter-rouge">TracerLog</code> if our effect type has an instance of <code class="highlighter-rouge">Sync</code> by a single import.</p>

<p>If you are a <a href="https://christopherdavenport.github.io/log4cats/">log4cats</a> user we can derive a <code class="highlighter-rouge">TracerLog</code> instance if you provide a <code class="highlighter-rouge">Logger</code> instance. All you have to do is to import <code class="highlighter-rouge">com.github.gvolpe.tracer.log4cats._</code> and add the extra dependency <code class="highlighter-rouge">http4s-tracer-log4cats</code>. See the <a href="https://github.com/gvolpe/http4s-tracer/blob/master/examples/src/main/scala/com/github/gvolpe/tracer/Log4CatsServer.scala">Log4CatsServer</a> example for more.</p>

<h4 id="choose-your-effect-type">Choose your effect type!</h4>

<p>Here we are going to be using <code class="highlighter-rouge">cats.effect.IO</code> but you could use your own effect.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">object</span> <span class="nc">Server</span> <span class="k">extends</span> <span class="nc">IOApp</span> <span class="o">{</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">run</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">ExitCode</span><span class="o">]</span> <span class="k">=</span>
    <span class="k">new</span> <span class="nc">Main</span><span class="o">[</span><span class="kt">IO</span><span class="o">].</span><span class="n">server</span><span class="o">.</span><span class="n">as</span><span class="o">(</span><span class="nc">ExitCode</span><span class="o">.</span><span class="nc">Success</span><span class="o">)</span>

<span class="o">}</span>
</code></pre></div></div>

<h3 id="running-the-application">Running the application</h3>

<p>This is how the activity log might look like for a simple POST request (logging activated):</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>4:13:48.985 <span class="o">[</span>scala-execution-context-global-17] INFO com.github.gvolpe.tracer.Tracer<span class="nv">$ </span>- <span class="o">[</span>TraceId] - <span class="o">[</span>02594e59-4b21-4d0a-aad5-5866a632fbb5] - Request<span class="o">(</span><span class="nv">method</span><span class="o">=</span>POST, <span class="nv">uri</span><span class="o">=</span>/users, <span class="nv">headers</span><span class="o">=</span>Headers<span class="o">(</span>HOST: localhost:8080, content-type: application/json, content-length: 30<span class="o">))</span>
14:13:49.282 <span class="o">[</span>scala-execution-context-global-17] INFO com.github.gvolpe.tracer.algebra<span class="nv">$UserAlgebra</span> - <span class="o">[</span>TraceId] - <span class="o">[</span>02594e59-4b21-4d0a-aad5-5866a632fbb5] - About to persist user: modersky
14:13:49.290 <span class="o">[</span>scala-execution-context-global-17] INFO com.github.gvolpe.tracer.repository.algebra<span class="nv">$UserRepository</span> - <span class="o">[</span>TraceId] - <span class="o">[</span>02594e59-4b21-4d0a-aad5-5866a632fbb5] - Find user by username: modersky
14:13:49.298 <span class="o">[</span>scala-execution-context-global-17] INFO com.github.gvolpe.tracer.repository.algebra<span class="nv">$UserRepository</span> - <span class="o">[</span>TraceId] - <span class="o">[</span>02594e59-4b21-4d0a-aad5-5866a632fbb5] - Persisting user: modersky
14:13:49.315 <span class="o">[</span>scala-execution-context-global-17] INFO com.github.gvolpe.tracer.Tracer<span class="nv">$ </span>- <span class="o">[</span>TraceId] - <span class="o">[</span>02594e59-4b21-4d0a-aad5-5866a632fbb5] - Response<span class="o">(</span><span class="nv">status</span><span class="o">=</span>201, <span class="nv">headers</span><span class="o">=</span>Headers<span class="o">(</span>Content-Length: 0, Trace-Id: 02594e59-4b21-4d0a-aad5-5866a632fbb5<span class="o">))</span>
</code></pre></div></div>

<p>Quite useful to trace the flow of your application starting out at each request. In a normal application, you will have thousands of requests and tracing the call-chain in a failure scenario will be invaluable.</p>

<h3 id="source-code">Source code</h3>

<p>This documentation is compiled with <a href="http://tpolecat.github.io/tut/">tut</a> to guarantee it’s always updated. However, it is always easier to have a project you can import and easily run so we’ve got you covered!</p>

<p>Find the source code in the <a href="https://github.com/gvolpe/http4s-tracer/tree/master/examples/src">examples module</a>.</p>

</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/http4s-tracer/highlight/highlight.pack.js"></script><script>hljs.configure({languages:['scala','java','bash']});
hljs.initHighlighting();
              </script><script src="/http4s-tracer/js/toc.js"></script><script>((window.gitter = {}).chat = {}).options = {
room: 'http4s-tracer/http4s-tracer'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script><script src="/http4s-tracer/js/main.js"></script></body></html>